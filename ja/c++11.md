# C++11

C++11 とは 2011年に新たに制定された C++ の新しい機能や記法のことである。以前の記法と比べ、C++ を初心者にも扱いやすくする機能も数多く追加されているため、本ドキュメントでは C++11 の機能を積極的に利用してゆく。

**【重要】本ドキュメントのコード例は基本的にC++11が有効であることを前提とする**。


## C++11 を有効にする

C++11を有効にするには Rcpp コード中に次の記述を追加する。

```cpp
// [[Rcpp::plugins("cpp11")]]
```

##おすすめ C++11 機能





### 初期化リスト

`{}`を使った変数の初期化。

```
// Vector の初期化
//次の3つは同じ値 c(1,2,3) となる
NumericVector v1 = NumericVector::create(1.0, 2.0, 3.0);
NumericVector v2 = {1.0, 2.0, 3.0};
NumericVector v3   {1.0, 2.0, 3.0}; // = は省略できる
```

初期化リストを関数の引数として渡すこともできる。その場合、自動的に関数の引数の型として解釈される。

```
void f(int x, NumericVector y){
  Rcout << "x " << x << "\n";
  Rcout << "y " << y << "\n";
}

// [[Rcpp::export]]
void rcpp_init(){
  //関数 f に初期化リストを渡す
  f({1}, {2.0, 3.0});
}

```


### auto：自動的な型定義

`auto` を使って変数を宣言すると、変数の型を代入する値に合わせて自動的に設定してくれる。

```
// i は int
auto  i  = 4;

NumericVector v;
// it は NumericVector::iterator
auto it = v.begin(); 
```


### decltype

`decltype`を使うと既存の変数や式と同じ型の変数を宣言することができる。

```
int i;
decltype(i) x; // x は int型 となる
```


### 範囲 for

R と同じスタイルで for 文を記述できる。


```
IntegerVector v{1,2,3};
int sum=0;
for(auto& x : v) {
  sum += x;
}
```




### ラムダ式

ラムダ式は関数オブジェクトを簡単に作成するための記法である。

ラムダ式は `[](){}` の書式で記述する。

* `[]` には、関数オブジェクト内で利用したいローカル変数のリストを記述する。
    * `[=x, &y]` ローカル変数 x 値だけコピーして利用できる、ローカル変数 y に直接アクセスできる。
    * `[=]`は、全てのローカル変数の値をコピーして利用できる
    * `[&]`は、全てのローカル変数に直接アクセスできる
    * `[]` は、ローカル変数にはアクセスしない
* `()`には、この関数オブジェクトに渡す引数を記述する
* `{}`には、処理内容を記述する。


この関数オブジェクトの返値の型は、`{}`内でリターンされた値の型が自動的に設定される。明示的に記述したい場合には、`[]()->int{}` のように記述する。

ラムダ式を用いることで、C++ でも R と同様のスタイルでコードを記述できることを、次の例は示している。

``` R
v <- c(1,2,3,4,5)
A <- 2.0
res <-
  sapply(v, function(x){A*x})
```

``` cpp
// [[Rcpp::plugins("cpp11")]]
// [[Rcpp::export]]
NumericVector rcpp_lambda_1(){
  NumericVector v = {1,2,3,4,5};
  double A = 2.0;
  NumericVector res =
    sapply(v, [&](double x){return A*x;});
  return res;
}
```

ラムダ式で作成した関数オブジェクトは保存しておくこともできる。

```cpp
// [[Rcpp::export]]
void rcpp_lambda_2(){
  NumericVector v  {1,2,3};
  
  //ラムダ式を保存
  auto square = [](double x){return x*x;};
  
  //保存した関数オブジェクトを使用する
  double x = square(10.0);
  
  Rcout << x << "\n";
  
}   

```